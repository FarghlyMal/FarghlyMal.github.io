---
title: "Expolring API resolving"
classes: wide
header:
  teaser: https://www.researchgate.net/publication/305755349/figure/fig4/AS:390261860519941@1470057087660/The-structure-of-the-Import-Address-Table-IAT.png
ribbon: DodgerBlue
description: "Exploring HOW IAT resolving is done "
categories:
  #- Malware Analysis
toc: true
---
# Dynamically IAT building

practicing malware analysis is a big challenge but make me happy so in this letter

I’m going to talk about one method of dynamically Api importing

in the next pic there is an indictor of resolving api cause calling a Dword has no meaning

but if we write an api link in this dword WoW we got it
so the function call sub_404653 will make some changes in that dword let’s get into it

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffea9a7f7-5d01-4955-a4e8-7ab15343be3c%2Fstart.png?id=6911cd3d-661f-45bd-87cc-c25b0697b377&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=780&userId=&cache=v2)

we found there is 2 calls to function and then there is anthor call to dword which make an indictor of that 2 function make the resolving process of

1- dll resolving at(**text:00404D61**) to get the library which have the exports to import api from it

2- api resolving at(**text:00404D75**) to get a specific apis which make the program do it’s job

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdaf34b0b-a241-40a2-8f6e-c9cfebb34c95%2FDll_resloving.png?id=7860c916-adae-499e-8ecb-9af9928dd585&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=800&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F978d07ae-2738-4cf7-b856-80edf73a6609%2FApi_resolving.png?id=efd857f3-ff6f-403c-8a48-f3425a01a762&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=800&userId=&cache=v2)

first let’s get into the first function which i called as Dll_resolving

it get the PEB Structure by moving (0x30h) into edi

after that it add (0x0Ch) to get the (peb_ldr_data) structure

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F70a1c209-b6b9-47df-b8de-8c4168284539%2FPEP.png?id=d22060c8-f961-4f11-9d0f-2eb54aab6cb0&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=670&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffe70aec8-22ca-4ecf-adee-17c0cfd454e4%2FMemory_order.png?id=00f85f52-1ac9-4869-83cd-3c24a7b91eef&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=580&userId=&cache=v2)

after getting a pointer to (In_memory_Order_Module_List) structure by adding (0x14h)

after that it get the name of the dll but we need to take care of some thing that’s the (In_memory_Order_Module_List) contians (Flink,Blink) so the first item of the structure

is an 8 byte element as explained in the pic

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9c83a25d-8264-41a3-b061-1bbb0162e3f1%2Fgetting_name_of_the_dll.png?id=945a55a3-9a11-4829-9adf-9c47c56ffbf6&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=670&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3e56fefe-6467-4bcc-b33d-2f624c1c84e1%2Fbasedllname.png?id=94204f90-5200-400c-8c17-0c76a8448049&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=670&userId=&cache=v2)

and after getting the name it will put all of in lower cases letters

and then get the base address of the dll by using (eax=[edi+10h]

remeber that the first element in the structure is an 8 byte

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7dea0f3a-c628-491e-906d-1eb4098b028b%2Fgetting_dll_base_address.png?id=5629d7f2-5512-4e06-9859-7c4041b5356d&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=670&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0771f912-2200-4e11-851b-ae245a49a581%2Fdllbaseaddress.png?id=05b5205e-dcc5-4718-a462-114996152004&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=670&userId=&cache=v2)

after getting the base address of the required DLL going to next step is to resolve apis

but it save some data in (esi,edi) before calling

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F686d3975-90da-4541-aaef-84e7caf5987a%2FApi_resolving.png?id=03ad67dd-fc2c-4b65-b97b-cfc474a88f5e&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=800&userId=&cache=v2)

getting into Api_resolving function

import table building

first it get a pointer to (elfanew)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fed5d14a6-dea7-4894-9d64-0f538d43c6f1%2Fgetting_elfanew.png?id=569aa88a-a337-4bb9-a51b-342537a33e8e&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=860&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F832e40ae-93dd-4559-a0ce-9e65fa7afc50%2Felfanew.png?id=7092516e-f0d8-43ab-a582-24fc374a3888&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=750&userId=&cache=v2)

need to explain some thing about PE headers

most important header i think is the optional header which is at (0x18h)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F28ead0ae-f577-4b9a-a630-d29bd66a1ce1%2Fimage_nt_header.png?id=e8b77e2a-a4af-4540-9a9b-45e9b7d11835&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=480&userId=&cache=v2)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F892d5895-7e4d-47ad-8f15-939dda2c4c3f%2FDataDirectory.png?id=46b5719d-b426-42c9-8f75-0ec8652bbc89&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=770&userId=&cache=v2)

adding a 0x60h to 0x18h(optional header base address)

leads us to the Data_Directory which contain important information about export table of an Dll

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc285ea76-6cd6-47f7-b097-8983002a8861%2FExport_table.png?id=91fe6d1b-6546-4dda-95de-ea5e4fedabe5&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=2000&userId=&cache=v2)

after getting a pointer to the export table directory

the binary adds the saved dll base address(saved in ebp register) to the Export_Directory address

and then add 0x20h to (**edx= Export_table RVA**) to get the AddressOfNames

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe04cf34e-6c73-44c2-824f-d69217e0132b%2Faddrssofname.png?id=e8f7e009-ed21-4162-8ba0-fba3034b617f&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=860&userId=&cache=v2)

after that it’s going to dynamically calculate a check sum for all the API in the Dll and compare it against needed API which it’s checksum value had been calculated and saved in the data section and mentioned by (**esi**) register

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F43ea75cd-de6d-476f-a41b-a85384272ecc%2Fchecksum_method_api.png?id=5391004e-71ff-48ff-94ac-673373e0c400&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=740&userId=&cache=v2)

the first hitted Api is (closeHandle)

after that it will get a linker to this function and save the address into the

(edi —→ points to a place to save API address)

as i still learning there some movements and additions i have not understand it

but i got some thing that is the line at (**0x004017A0h**)

mean it’s going to get the address form the array of

(**address_of_names_ordinals**) which is in the structure of Export_table_directory

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F23532540-09df-49c5-bcf3-59633a527509%2Fgetting_api_address.png?id=fcfd84e1-cf80-44db-9d6d-72b3cf5a8e26&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=840&userId=&cache=v2)

let’s do that using the Debugger

here there is the first call followed by a call to dword

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe98789dd-f855-4882-ab96-38c924ec87f5%2Fdebgger_1.png?id=31e1c29a-3a93-42f0-8646-f8627e6aabc0&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=1500&userId=&cache=v2)

getting into that function as explained

there is 2 calls one for dll resolving(sub_401728) and one for the api bulding (sub_40175E)

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ff0dafc1b-872e-4a8e-a4e4-8d49f77fb056%2Fdebgger_2q.png?id=7298fb49-a4f8-4e7e-b645-f65dcaf8147e&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=1600&userId=&cache=v2)

and the value stored in edi is a pointer to IAT before building

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3a982cc0-06c8-4e61-b031-6865b477490c%2Fdebugger_3.png?id=b3346bd2-ab67-4421-98a1-aaf833c3436d&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=2000&userId=&cache=v2)

and there is a calls to dword which save in eax register

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe956658b-82b9-45b8-983e-d75a1558a6c1%2Fdebgger_4.png?id=a6eea2a5-d684-41ea-977f-5af40d987dbb&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=1670&userId=&cache=v2)

after calling the above function let’s look at the IAT ….WOW it’s amazing

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4e8fcb0b-3c97-4fc2-82c8-c1aadde97f17%2Fdebgger_5.png?id=82867bff-a19b-4667-9fa1-3c01ce6d724d&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=2000&userId=&cache=v2)

and there is no calls to dowrds

![](https://pricey-stop-fe3.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5f2abf80-2d4c-4a87-94e7-b836f97c4ba3%2Fdebugger_6.png?id=ede8e0cf-85d1-4256-ade6-c166b321dbb1&table=block&spaceId=1f98e206-9e2e-4e4a-b39a-c171b9f07bd8&width=2000&userId=&cache=v2)

I think the malware is now easy to analysis

in the next letter i will analyze it and build the IAT using Python script to make it like professionals

ThX
